---
import { actions, isInputError } from "astro:actions";

export const prerender = false;

const result = Astro.getActionResult(actions.contact);
const { env } = Astro.locals.runtime;
---

<div>
  {
    result?.data && (
      <div class="mb-4 rounded-lg border border-emerald-600 bg-emerald-50 px-4 py-3 text-emerald-700 animate-slide-in-down">
        <p class="font-semibold">✅ {result.data.message}</p>
      </div>
    )
  }

  {
    result?.error && !isInputError(result.error) && (
      <div class="mb-4 rounded-lg border border-red-300 bg-red-50 px-4 py-3 text-red-700 animate-slide-in-down">
        <p class="font-semibold">❌ {result.error.message}</p>
      </div>
    )
  }

  <form
    method="POST"
    action={actions.contact}
    class="flex flex-col justify-center"
    id="contact-form"
  >
    <div class="mb-2">
      <input
        type="text"
        name="name"
        placeholder="Name"
        class="w-full h-10 px-3 text-base border-gray-400 text-gray-700 placeholder-gray-600 border rounded-lg focus:shadow-outline focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200 transition-all duration-300"
      />
      {
        isInputError(result?.error) && result.error.fields.name && (
          <span class="text-xs text-red-700 animate-shake inline-block" role="alert">
            {result.error.fields.name.join(", ")}
          </span>
        )
      }
    </div>
    <div class="mb-2">
      <input
        type="text"
        name="email"
        placeholder="Email"
        class="w-full h-10 px-3 text-base border-gray-400 text-gray-700 placeholder-gray-600 border rounded-lg focus:shadow-outline focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200 transition-all duration-300"
      />
      {
        isInputError(result?.error) && result.error.fields.email && (
          <span class="text-xs text-red-700 animate-shake inline-block" role="alert">
            {result.error.fields.email.join(", ")}
          </span>
        )
      }
    </div>
    <div class="mb-2">
      <textarea
        name="message"
        placeholder="Message"
        rows={3}
        class="w-full h-16 px-3 py-2 text-base border-gray-400 text-gray-700 placeholder-gray-600 border rounded-lg focus:shadow-outline focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200 transition-all duration-300"
      ></textarea>
      {
        isInputError(result?.error) && result.error.fields.message && (
          <span class="text-xs text-red-700 animate-shake inline-block" role="alert">
            {result.error.fields.message.join(", ")}
          </span>
        )
      }
    </div>

    <!-- Honeypot field - hidden from users but visible to bots -->
    <input
      type="text"
      name="company"
      autocomplete="off"
      tabindex="-1"
      style="position: absolute; left: -9999px; width: 1px; height: 1px;"
      aria-hidden="true"
    />

    <!-- Render time field for bot detection -->
    <input type="hidden" name="renderTime" id="renderTime" value="" />

    <!-- Cloudflare Turnstile captcha -->
    <div class="mb-4 flex flex-col items-center">
      <div class="cf-turnstile" data-sitekey={env.PUBLIC_TURNSTILE_SITE_KEY}></div>
      {
        isInputError(result?.error) && result.error.fields["cf-turnstile-response"] && (
          <span class="text-xs text-red-700 animate-shake inline-block" role="alert">
            {result.error.fields["cf-turnstile-response"].join(", ")}
          </span>
        )
      }
    </div>

    <input
      type="submit"
      value="Send message ✉️"
      class="self-center h-10 px-5 font-semibold text-white rounded-lg transition-all duration-300 bg-black hover:bg-emerald-600 hover:cursor-pointer hover:-translate-y-1 hover:shadow-lg active:translate-y-0 active:shadow-md"
    />
  </form>
</div>

<!-- Cloudflare Turnstile Script -->
<script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>

<!-- Render time validation script -->
<script>
  // Set the render time when the page loads
  document.addEventListener('DOMContentLoaded', () => {
    const renderTimeField = document.getElementById('renderTime') as HTMLInputElement;
    if (renderTimeField) {
      renderTimeField.value = Date.now().toString();
    }
  });
</script>
